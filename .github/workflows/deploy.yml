name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
    
    - name: Run tests
      working-directory: ./app
      run: npm test -- --run
    
    - name: Build production bundle
      working-directory: ./app
      run: npm run build
      env:
        NODE_ENV: production
    
    - name: Generate build info
      working-directory: ./app/dist
      run: |
        cat > build-info.json << EOF
        {
          "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "workflow": "${{ github.run_id }}",
          "actor": "${{ github.actor }}"
        }
        EOF
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: app/dist
        retention-days: 30
  
  deploy-pages:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: production-build
        path: ./dist
    
    - name: Setup Pages
      uses: actions/configure-pages@v5
    
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Deployment summary
      run: |
        echo "### ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** GitHub Pages" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
  
  health-check:
    name: Post-Deployment Health Check
    needs: deploy-pages
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for deployment
      run: sleep 30
    
    - name: Check deployment health
      run: |
        echo "ðŸ¥ Running health checks..."
        
        # This will be updated after first deployment with actual URL
        # For now, just show the check would run
        echo "âœ… Deployment workflow completed successfully"
        echo "ðŸ“ Manual verification required for first deployment"
  
  notify:
    name: Deployment Notification
    needs: [deploy-pages, health-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment status
      run: |
        if [ "${{ needs.deploy-pages.result }}" == "success" ] && [ "${{ needs.health-check.result }}" == "success" ]; then
          echo "### âœ… Deployment Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All stages passed successfully." >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Deployment Pipeline Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Status:** ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check Status:** ${{ needs.health-check.result }}" >> $GITHUB_STEP_SUMMARY
        fi
