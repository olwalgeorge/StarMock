name: Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scans every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  vulnerability-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
    
    - name: Run npm audit
      working-directory: ./app
      run: |
        echo "üîç Running npm audit..."
        npm audit --audit-level=moderate --json > audit-results.json || true
        
        # Display results
        cat audit-results.json | jq '.metadata'
        
        # Fail if there are high or critical vulnerabilities
        CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
        HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
        
        if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
          echo "‚ùå Found $CRITICAL critical and $HIGH high severity vulnerabilities"
          npm audit
          exit 1
        else
          echo "‚úÖ No critical or high severity vulnerabilities found"
        fi
    
    - name: Check for known security issues
      working-directory: ./app
      run: |
        echo "üîç Checking for known security advisories..."
        npm audit --audit-level=low || echo "‚ö†Ô∏è Low/Moderate vulnerabilities detected"
    
    - name: Upload audit results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: npm-audit-results
        path: app/audit-results.json
        retention-days: 30

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript, typescript
        queries: security-and-quality
    
    - name: Autobuild
      uses: github/codeql-action/autobuild@v3
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified

  dependency-check:
    name: License and Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
    
    - name: Check for dependency updates
      working-directory: ./app
      run: |
        echo "üì¶ Checking for outdated dependencies..."
        npm outdated || echo "Some dependencies have updates available"
    
    - name: Verify package integrity
      working-directory: ./app
      run: |
        echo "üîê Verifying package integrity..."
        npm ls --all || echo "Dependency tree check complete"
